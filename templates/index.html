<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆìŒì„ ë‚˜ëˆ„ëŠ” ì¼ê¸°ì¥</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
</head>
<body>
    <div class="container">
        <div class="user-info">
            <span>{{ session['name'] }}ë‹˜ì˜ ì¼ê¸°ì¥</span>
            <a href="{{ url_for('logout') }}" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
        <h1>ì˜¤ëŠ˜ì˜ ë§ˆìŒì„ ë‹´ì€ ì¼ê¸°ì¥</h1>
        
        <!-- ìº˜ë¦°ë” ì„¹ì…˜ -->
        <div class="calendar-section">
            <div id="calendar"></div>
        </div>

        <div class="diary-section">
            <form id="diaryForm">
                <textarea id="diary" placeholder="ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë– ì…¨ë‚˜ìš”?&#10;ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”..."></textarea>
                <button type="submit">ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³ í–ˆì—‰</button>
            </form>
        </div>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div id="letterModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="letter">
                <div class="emotions-chart">
                    <div class="emotion-bars"></div>
                </div>
                <div class="letter-content" id="responseContent"></div>
                <div class="letter-date" id="currentDate"></div>
            </div>
        </div>
    </div>

    <style>
    .emotions-chart {
        margin-bottom: 20px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 8px;
    }

    .emotion-bar {
        display: flex;
        align-items: center;
        margin: 5px 0;
    }

    .emotion-label {
        width: 80px;
        font-size: 14px;
    }

    .emotion-progress {
        flex-grow: 1;
        height: 20px;
        background: #eee;
        border-radius: 10px;
        overflow: hidden;
    }

    .emotion-fill {
        height: 100%;
        transition: width 0.3s ease;
    }

    .emotion-value {
        margin-left: 10px;
        width: 50px;
        text-align: right;
        font-size: 14px;
    }
    </style>

    <script>
        // emotions_dataë¥¼ ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
        const emotions_data = {{ emotions|tojson|safe }};
        
        const modal = document.getElementById('letterModal');
        const closeButton = document.querySelector('.close-button');

        // ê°ì •ì— ë”°ë¥¸ ìƒ‰ìƒ ë§¤í•‘
        const emotionColors = {
            'HAPPY': '#FFD700',  // í–‰ë³µ - ë…¸ë€ìƒ‰
            'SAD': '#87CEEB',    // ìŠ¬í”” - í•˜ëŠ˜ìƒ‰
            'CALM': '#98FB98',   // í‰ì˜¨ - ì—°ë‘ìƒ‰
            'JOY': '#FFA500',    // ê¸°ì¨ - ì£¼í™©ìƒ‰
            'ANGRY': '#FF6B6B'   // í™”ë‚¨ - ë¹¨ê°„ìƒ‰
        };

        // ê°ì • ì´ëª¨ì§€ ì •ì˜
        const emotionEmojis = {
            'HAPPY': 'ğŸ˜Š',       // í–‰ë³µ
            'SAD': 'ğŸ˜¢',         // ìŠ¬í””
            'CALM': 'ğŸ˜Œ',        // í‰ì˜¨
            'JOY': 'ğŸ˜ƒ',         // ê¸°ì¨
            'ANGRY': 'ğŸ˜ '        // í™”ë‚¨
        };

        // ë‚ ì§œ í˜•ì‹ì„ í†µì¼í•˜ëŠ” í•¨ìˆ˜ ì¶”ê°€
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ìº˜ë¦°ë” ì´ˆê¸°í™”
        const calendar = flatpickr("#calendar", {
            inline: true,
            locale: 'ko',
            defaultDate: 'today',
            onChange: async function(selectedDates, dateStr) {
                try {
                    const formattedDate = formatDate(selectedDates[0]);
                    const response = await fetch(`/get_diary?date=${formattedDate}`);
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('responseContent').innerText = data.content;
                        document.getElementById('currentDate').innerText = formattedDate;
                        createEmotionChart(data.emotions);
                        document.getElementById('letterModal').style.display = "block";
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            },
            onDayCreate: function(dObj, dStr, fp, dayElem) {
                const formattedDate = formatDate(dayElem.dateObj);
                if (emotions_data[formattedDate]) {
                    const mainEmotion = emotions_data[formattedDate].mainEmotion;
                    dayElem.style.backgroundColor = emotionColors[mainEmotion];
                    const emoji = document.createElement('span');
                    emoji.innerHTML = emotionEmojis[mainEmotion];
                    emoji.style.position = 'absolute';
                    emoji.style.top = '2px';
                    emoji.style.right = '2px';
                    emoji.style.fontSize = '10px';
                    dayElem.appendChild(emoji);
                }
            }
        });

        // ê°ì • ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
        function createEmotionChart(emotions) {
            const emotionBarsDiv = document.querySelector('.emotion-bars');
            emotionBarsDiv.innerHTML = '';

            Object.entries(emotions).forEach(([emotion, value]) => {
                const barDiv = document.createElement('div');
                barDiv.className = 'emotion-bar';
                
                const label = document.createElement('div');
                label.className = 'emotion-label';
                label.textContent = emotion;
                
                const progress = document.createElement('div');
                progress.className = 'emotion-progress';
                
                const fill = document.createElement('div');
                fill.className = 'emotion-fill';
                fill.style.width = `${value * 100}%`;
                fill.style.backgroundColor = emotionColors[emotion];
                
                const valueDiv = document.createElement('div');
                valueDiv.className = 'emotion-value';
                valueDiv.textContent = `${(value * 100).toFixed(0)}%`;
                
                progress.appendChild(fill);
                barDiv.appendChild(label);
                barDiv.appendChild(progress);
                barDiv.appendChild(valueDiv);
                emotionBarsDiv.appendChild(barDiv);
            });
        }

        // ê¸°ì¡´ í¼ ì œì¶œ ì´ë²¤íŠ¸ì— ê°ì • ë¶„ì„ ìš”ì²­ ì¶”ê°€
        document.getElementById('diaryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const diary = document.getElementById('diary').value;
            
            try {
                const emotionResponse = await fetch('/analyze_emotion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ diary: diary })
                });
                
                const emotionData = await emotionResponse.json();
                
                // ìº˜ë¦°ë” ì—…ë°ì´íŠ¸
                calendar.redraw();
                
                const responseContent = document.getElementById('responseContent');
                const dateDiv = document.getElementById('currentDate');
                
                // ë‚ ì§œ í˜•ì‹ í†µì¼
                const today = new Date();
                const formattedDate = formatDate(today);
                
                // AIê°€ ìƒì„±í•œ ë‹µì¥ í‘œì‹œ
                responseContent.innerText = emotionData.content;
                dateDiv.innerText = formattedDate;
                modal.style.display = "block";
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('diary').value = '';
                
            } catch (error) {
                console.error('Error:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        closeButton.addEventListener('click', () => {
            modal.style.display = "none";
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = "none";
            }
        });
    </script>
</body>
</html>
